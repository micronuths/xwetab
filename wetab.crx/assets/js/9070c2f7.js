"use strict";(globalThis.webpackChunkinfinity_hitab_client=globalThis.webpackChunkinfinity_hitab_client||[]).push([[1191],{51191:(t,e,n)=>{n.r(e),n.d(e,{NEWCHAT_ID:()=>w,useChatGptStore:()=>y});var s=n(10435),i=n(22140),o=n(74003),a=n(17904);const r=new(n(63477)._P)("api-host/get",6e5);let c=o.kP;function d(){const t=localStorage.getItem("chatAiHost");t&&(c=t),(async t=>{try{if(r.isLocked)return["locked error"];const e=await a.hj.get(`${o.H}api-host/get`,{type:t},{_single:!0,_auth:!0});if(0===e.code&&e.data)return r.setLock(),[null,e.data];throw e}catch(t){return["catch error"]}})("chatai").then((t=>{let[e,n]=t;e||n&&localStorage.setItem("chatAiHost",n.host)})).catch((t=>{}))}var h=n(84522),l=n(80661),g=n(77363),u=n(60385),v=n(54348);const p=function(t){return function(e,n,s){var i=Object(e);if(!(0,u.Z)(e)){var o=(0,g.Z)(n,3);e=(0,v.Z)(e),n=function(t){return o(i[t],t,i)}}var a=t(e,n,s);return a>-1?i[o?e[a]:a]:void 0}};var m=n(30967);const L=p(m.Z),f=(0,i.useUserStore)(),w="newChat",I={name:"新的聊天",id:w,messages:[],updateTime:l().format("YYYY-MM-DD HH:mm")},y=(0,s.Q_)(h.BU.chatgpt,{syncStorage:{watch:["customLinks","panelType","linksList","chatTips","conversionList"]},syncCloud:{watch:["customLinks","panelType"]},state:()=>({modalShow:!1,linksList:[],selectedLink:null,panelType:"chatai",customLinks:[],conversionList:[I],activeConversionId:w,chatTips:"世界上有多少人口？",pending:!1,chatLoading:!1,pagination:{pageNo:0,loading:!1,finished:!1},sponsorShow:!1,controller:null,tempId:void 0}),getters:{conversionDataList(){return this.conversionList.map((t=>{var e,n;return{...t,name:(null===(e=t.messages[0])||void 0===e?void 0:e.content)||"新的聊天",updateTime:l(null===(n=t.messages[0])||void 0===n?void 0:n.updateTime).format("YYYY-MM-DD HH:mm")}}))},activeConversionItem(){const t=this.conversionList.find((t=>t.id===this.activeConversionId));return t||I},userOperationDisabled(){return!f.isLogin||this.pending||this.chatLoading}},actions:{setModal(t){this.modalShow=t},setPanelType(t){this.panelType=t},setSelectLink(t){this.selectedLink=t},addCustomLink(t){const e=[...this.customLinks];e.push(t),this.customLinks=e},removeCustomLink(t){const e=[...this.customLinks];e.splice(t,1),this.customLinks=e},setActiveConversionId(t){this.activeConversionId=t},async deleteConversionItem(t){this.conversionList=this.conversionList.filter((e=>e.id!==t)),t===this.activeConversionId&&(this.conversionDataList.length>0?this.activeConversionId=this.conversionDataList[0].id:this.newChatHandler());const[e,n]=await(async t=>{try{d();const e=await a.hj.post(`${c}chat/delete`,{conversationId:t},{_auth:!0});if(0===e.code&&e.data)return[null,e.data];throw e}catch(t){return["catch error"]}})(t)},newChatHandler(){const t={name:"新的聊天",id:w,messages:[],updateTime:l().format("YYYY-MM-DD HH:mm")};this.conversionList=[t,...this.conversionList],this.activeConversionId=w},async reqGptLinks(){const[t,e]=await(async()=>{try{d();const t=await a.hj.get(`${c}chat/list`);if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}})();!t&&e&&(this.linksList=e,this.selectedLink=e[0])},async reqConversionList(t){if(this.pagination.loading||this.pagination.finished)return;this.pagination={...this.pagination,loading:!0};const[e,n]=await(async(t,e)=>{d();try{const n=await a.hj.get(`${c}chat/history`,{pageNo:t,pageSize:e},{_auth:!0});if(0===n.code&&n.data)return[null,n.data];throw n}catch(t){return["catch error"]}})(this.pagination.pageNo);if(!e&&n){var s;if(t)this.conversionList=[I,...n.list];else if(this.conversionList=[...this.conversionList,...n.list],this.activeConversionId===w)this.activeConversionId=(null===(s=n.list[0])||void 0===s?void 0:s.id)||w;n.totalPages-n.pageNo<=1?this.pagination={...this.pagination,finished:!0,loading:!1}:this.pagination={pageNo:n.pageNo+1,loading:!1,finished:!1}}},addUserMessage(t,e){const n=[...this.conversionList],s=n.find((t=>t.id===e));null==s||s.messages.push({role:"user",content:t,updateTime:l().valueOf()}),this.conversionList=n},onClickTryIt(){this.sendChatMessage(this.chatTips,w)},async reqChatTips(){const[t,e]=await(async()=>{try{d();const t=await a.hj.get(`${c}chat/recommended`);if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}})();!t&&e&&(this.chatTips=e)},updatePendingMessage(t){const e=[...this.conversionList],n=e.find((e=>e.id===t.conversionId)),s=n.messages.find((t=>t.loading));s&&(s.loading=!1,s.pending=!0),this.pending=!0;const i=n.messages.find((t=>t.pending));if(t.error)return i.error=!0,i.content=t.content,i.pending=!1,i.extra=t.showNewBtn,this.pending=!1,void(this.conversionList=e);t.done&&(i.pending=!1,t.conversionId===w&&t.id&&(n.id=t.id,this.activeConversionId=t.id),this.pending=!1),t.id&&(this.tempId=t.id),i.content+=t.content,this.conversionList=e},createLoadingMsg(t){const e=[...this.conversionList];e.find((e=>e.id===t)).messages.push({role:"assistant",content:"",loading:!0}),this.conversionList=e},async sendChatMessage(t,e){this.chatLoading=!0,this.controller=null,this.addUserMessage(t,e),this.createLoadingMsg(e);const n=e===w?void 0:e,[s,i]=await(async(t,e)=>{try{return d(),[null,await a.hj.post(`${c}chat/conversation-v2`,{prompt:t,conversationId:e},{_auth:!0,_stream:!0,fetchOpts:{timeout:1e4}})]}catch(t){return["catch error"]}})(t,n);if(s||!i)return void this.updatePendingMessage({conversionId:e,content:"系统错误，请重试",error:!0,done:!0});const[o,r]=i;r&&(this.controller=r),this.chatLoading=!1,this.streamReaderToText(o,e)},async streamReaderToText(t,e){try{const n=await t.read();if(n.done)return;const s=n.value;let i="";i=new TextDecoder("utf-8").decode(s);const o=i.split("_e79218965e_").filter((t=>!!t));this.handleChunksText(o,e),this.streamReaderToText(t,e)}catch(t){}},deleteLastMessage(t,e){const n=[...this.conversionList],s=n.find((t=>t.id===e)),i=(0,m.Z)(s.messages,(e=>e.role===t));s.messages.splice(i,1),this.conversionList=n},async reGenerateLastAnwser(t){this.controller=null;const e=[...this.conversionList].find((e=>e.id===t)),n=e.messages.find((t=>t.error));if(this.deleteLastMessage("assistant",t),n){const n=L(e.messages,(t=>"user"===t.role)).content;return this.deleteLastMessage("user",t),void this.sendChatMessage(n,t)}this.createLoadingMsg(t);const[s,i]=await(async t=>{try{return d(),[null,await a.hj.post(`${c}chat/regenerate-v2`,{conversationId:t},{_auth:!0,_stream:!0})]}catch(t){return["catch error"]}})(t);if(s||!i)return void this.updatePendingMessage({conversionId:t,content:"系统错误，请重试",error:!0,done:!0});const[o,r]=i;r&&(this.controller=r),this.streamReaderToText(o,t)},handleChunksText(t,e){t.forEach((t=>{try{const n=JSON.parse(t);switch(n.code){case 0:const{content:t,id:s}=n.data;this.updatePendingMessage({conversionId:e,content:t,id:s||""});break;case 5001:this.updatePendingMessage({conversionId:e,content:"",id:n.data.conversationId,done:!0});break;case 4002:f.getProfile(),this.updatePendingMessage({conversionId:e,content:"系统错误，请重试",error:!0,done:!0});break;case 5002:case 5003:case 1001:this.updatePendingMessage({conversionId:e,content:n.message||"系统错误",error:!0,done:!0});break;case 5004:this.updatePendingMessage({conversionId:e,content:n.message||"系统错误",error:!0,done:!0,showNewBtn:!0});break;default:this.updatePendingMessage({conversionId:e,content:n.message||"系统错误，请稍后重试",error:!0,done:!0})}}catch(t){this.updatePendingMessage({conversionId:e,content:"系统错误，请重试",error:!0,done:!0})}}))},setSponsorShow(t){this.sponsorShow=t},abourtStream(){this.controller&&(this.controller.abort(),this.controller=null,this.updatePendingMessage({conversionId:this.activeConversionId,content:"",id:this.tempId,done:!0}))}}})},30967:(t,e,n)=>{n.d(e,{Z:()=>c});var s=n(46146),i=n(77363),o=n(60275),a=Math.max,r=Math.min;const c=function(t,e,n){var c=null==t?0:t.length;if(!c)return-1;var d=c-1;return void 0!==n&&(d=(0,o.Z)(n),d=n<0?a(c+d,0):r(d,c-1)),(0,s.Z)(t,(0,i.Z)(e,3),d,!0)}}}]);